---
title: "Data Gathering"
engine: knitr
execute:
    freeze: true
---


For this project, I need to gather a range of data on retail investor sentiment. Reviewing the literature, it does not appear that a consesus has been reached on which mediums are most useful for measuring retail investor trades, let alone their sentiment. After an extensive review, I decided to try and construct a set of trading signals from the following:
1. Daily NASDAQ data on the top-10 retail investor held companies (API through R Quandl Package)
2. Text data from popular stock-trading subreddits (Reddit API through R)
3. Stocktwits mentions of popular companies through (Stocksera API in Python)
4. Weekly polls of investor sentiment from the American Association of Individual Investors (downloaded as CSV)
5. Text data from major financial new companies

Starting with dataset 1: Nasdaq retail investor holdings
```{r}
library(tidyverse)
library(Quandl)
library(lubridate)
library(RedditExtractoR)
library(reticulate)
library(xlsx)

Quandl.api_key("psq4nx69HDimf2kQcxZJ")
data <- Quandl.datatable("NDAQ/RTAT10", paginate = TRUE)

cleanData <- data %>% 
    mutate(date = ymd(date)) %>%
    filter(year(date) > 2019)

cleanData <- cleanData[order(cleanData$date),]
cleanData$deltaActivity <- vector(mode = "numeric", length = nrow(cleanData))
cleanData$deltaSentiment <- vector(mode = "numeric", length = nrow(cleanData))
cleanData$newEntry <- vector(mode = 'logical', length = nrow(cleanData))

for(i in 1:nrow(cleanData)) {
    if(i %% 1000 == 0) {
        print(i)
    }
    prevDay <- cleanData %>%
        filter(day(date) == day(cleanData$date[i]) - 1) %>%
        filter(ticker == cleanData$ticker[i])

    if(nrow(prevDay) > 0) {

        cleanData$deltaActivity[i] = cleanData$activity[i] - prevDay$activity[1]
        cleanData$deltaSentiment[i] = cleanData$sentiment[i] - prevDay$sentiment[1]
        cleanData$newEntry[i] = FALSE
    
    }else {
        cleanData$newEntry[i] = TRUE
    }
}

colnames(cleanData)
hist(cleanData$deltaActivity)

head(cleanData, 100)
getwd()
#write.csv(cleanData, "./data/01-modified-data/cleanRTAT.csv")
```

```{python}

import pandas as pd
import numpy as np
import quandl
import nasdaqdatalink


quandl.ApiConfig.api_key = 'psq4nx69HDimf2kQcxZJ'
table1 = quandl.get_table('NDAQ/RTAT10', date='2023-09-28,2023-09-27,2023-09-26', ticker='TSLA,TQQQ,SQQQ')

print(table1)


```

Here I put my api key into the quandl function and I am able to get data going back to 2016 with no issue.

Dataset 2: Text data from reddit

```{r}

# get a particular stock's mentions in titles in each of the 7 subreddits
# found subreddits by measuring overlap from https://subredditstats.com/subreddit-user-overlaps/superstonk
# which is calculated based on how likely users are to post on one or the other subs
# targeting investment related subs with >400k users
# loop through subreddits and get titles from past month


#install.packages("RedditExtractoR", repos='https://cloud.r-project.org/')


stockSubreddits <- c(
    "wallstreetbets",
    "stocks",
    "options",
    "investing",
    "stockamrket",
    "superstonk",
    "wallstreetbetsnew"
)



links <- find_thread_urls(keywords = "QQQ", subreddit = "stocks", sort_by = "top", period = "all")

links <- tibble(links)

links$ticker = "QQQ"

# get all unique stocks in the dataset of top retail-traded securities
tempClean <- read.csv('../data/01-modified-data/cleanRTAT.csv')


topStocks <- sort(table(tempClean$ticker), decreasing = TRUE)[1:100]

uqTickers <- rownames(topStocks)

print(uqTickers)

for(i in 1:length(uqTickers)) {
    print(i / nrow(uqTickers))
    
    templinks <- find_thread_urls(keywords = uqTickers[i], subreddit = "stocks", sort_by = "top", period = "all")
    templinks$ticker <- uqTickers[i]
    links <- rbind(links, templinks)
}



#write.xlsx(links,"../data/01-modified-data/sampleRedditText.xlsx")

```

Here I have gathered a list of 7 stock trading subreddits, which I created by searching for subreddits which mentioned individual stocks and investing, which also had more than ~400k subscribers. Then, I can use the find_thread_urls command to get a list of threads which mention particular keywords. For this initial gathering step, I simply gather posts with they keyword "SPY," a ticker for the S&P 500, from r/stocks, a major investing subreddit.

Updated Method: using r/stocks only, get posts for the 100 most common tickers in the most-held datatable.


3. Stocktwits rankings
```{python}
# stocksera
# https://pypi.org/project/stocksera/
# use this for news ratings, stocktwits website mentions and ranking
# api key: 2qs0tTwf.8sC7wUQ1Pf5zroD3IHx3XVTLwpHUifZ1

import subprocess
import sys

def install(name):
    subprocess.call([sys.executable, '-m', 'pip', 'install', name])

#install("stocksera")

import stocksera

client = stocksera.Client(api_key="2qs0tTwf.8sC7wUQ1Pf5zroD3IHx3XVTLwpHUifZ1")


stw = client.stocktwits(ticker = "QQQ")
print(stw)



sbrs = client.wsb_mentions(days=500, ticker="QQQ")
print(sbrs)
```


Dataset 4: (In Progress) Weekly Investor Sentiment from AAII
```{r}
# AAII weekly survey data https://www.aaii.com/sentimentsurvey/sent_results
# read in as csv 

getwd()
aaWeekly <- read.csv("./data/00-raw-data/sentiment_aaii.csv")
head(aaWeekly)


```


